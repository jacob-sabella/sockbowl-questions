plugins {
	id 'java'
	id 'org.springframework.boot' version '3.3.3'
	id 'io.spring.dependency-management' version '1.1.6'
	id 'maven-publish'
}

ext { springAiVersion = "1.0.0-M6" }

group = 'com.soulsoftworks'
version = resolveVersion()

java {
	sourceCompatibility = JavaVersion.VERSION_17
	targetCompatibility = JavaVersion.VERSION_17
}

repositories { mavenCentral() }

dependencies {
	implementation 'org.springframework.boot:spring-boot-starter'
	implementation 'org.springframework.boot:spring-boot-starter-data-neo4j'
	implementation 'org.springframework.boot:spring-boot-starter-web'
	implementation 'org.springframework.boot:spring-boot-starter-graphql'
	implementation 'com.google.code.gson:gson:2.11.0'
	implementation 'org.springframework.ai:spring-ai-ollama-spring-boot-starter:1.0.0-M6'
	implementation 'org.springframework.ai:spring-ai-neo4j-store-spring-boot-starter:1.0.0-M6'
	implementation 'org.springframework.ai:spring-ai-mcp-client-spring-boot-starter:1.0.0-M6'
	implementation 'com.github.victools:jsonschema-generator:4.38.0'

	compileOnly 'org.projectlombok:lombok:1.18.34'
	annotationProcessor 'org.projectlombok:lombok:1.18.34'
	testCompileOnly 'org.projectlombok:lombok:1.18.34'
	testAnnotationProcessor 'org.projectlombok:lombok:1.18.34'

	runtimeOnly 'org.postgresql:postgresql'
	testImplementation 'org.springframework.boot:spring-boot-starter-test'
}

tasks.named('test') { useJUnitPlatform() }

/* -------------------------- Models-only artifacts -------------------------- */
tasks.register('modelsJar', Jar) {
	group = 'build'
	description = 'Jar containing only com.soulsoftworks.sockbowlquestions.models.* classes'
	from sourceSets.main.output
	include 'com/soulsoftworks/sockbowlquestions/models/**'
	archiveBaseName = 'sockbowlquestions-models'
}

tasks.register('modelsSourcesJar', Jar) {
	group = 'build'
	description = 'Sources jar for the models-only artifact'
	from sourceSets.main.allSource
	include 'com/soulsoftworks/sockbowlquestions/models/**'
	archiveBaseName = 'sockbowlquestions-models'
	archiveClassifier = 'sources'
}

/* ------------------------------ Publishing --------------------------------- */
publishing {
	publications {
		register("models", MavenPublication) {
			groupId = project.group as String
			artifactId = "sockbowlquestions-models"
			version = project.version as String

			artifact tasks.named("modelsJar").get()
			artifact tasks.named("modelsSourcesJar").get()

			pom {
				name = "Sockbowl Questions Models"
				description = "Models under com.soulsoftworks.sockbowlquestions.models"
				url = "https://github.com/${System.getenv('GITHUB_REPOSITORY') ?: 'OWNER/REPO'}"
				licenses {
					license {
						name = "Apache License, Version 2.0"
						url = "https://www.apache.org/licenses/LICENSE-2.0"
						distribution = "repo"
					}
				}
				scm {
					def repo = System.getenv('GITHUB_REPOSITORY') ?: 'OWNER/REPO'
					url = "https://github.com/${repo}"
					connection = "scm:git:https://github.com/${repo}.git"
					developerConnection = "scm:git:ssh://git@github.com/${repo}.git"
				}
				developers { developer { id = "jsabella"; name = "Jacob Sabella" } }
			}
		}
	}
	repositories {
		// GitHub Packages (Maven)
		maven {
			name = "GitHubPackages"
			url = uri("https://maven.pkg.github.com/${System.getenv('GITHUB_REPOSITORY') ?: 'OWNER/REPO'}")
			credentials {
				username = (System.getenv("GITHUB_ACTOR") ?: (project.findProperty("gpr.user") ?: "")) as String
				password = (System.getenv("GITHUB_TOKEN") ?: (project.findProperty("gpr.key") ?: "")) as String
			}
		}
	}
}

/* ----------------------------- Spring Boot image --------------------------- */
bootBuildImage {
	createdDate = "now"
	def repo = (System.getenv('GITHUB_REPOSITORY') ?: 'OWNER/REPO')
	imageName = "ghcr.io/${repo}:${project.version}"
}

/* ---------------------------- Dependency management ------------------------ */
dependencyManagement {
	imports { mavenBom "org.springframework.ai:spring-ai-bom:$springAiVersion" }
}

/* ------------------------------- Utilities -------------------------------- */
tasks.register('printVersion') {
	group = 'help'
	description = 'Prints the current project version'
	doLast { println project.version }
}

static String resolveVersion() {
	String gitRef = System.getenv('GITHUB_REF')
	if (gitRef?.startsWith('refs/tags/')) {
		String tag = gitRef.substring('refs/tags/'.length())
		return tag.startsWith('v') ? tag.substring(1) : tag
	}
	// Non-tag build: use latest tag as base -> X.Y.Z-SNAPSHOT; fallback to 0.0.0-SNAPSHOT
	String latestTag = execAndRead("git describe --tags --abbrev=0")
	if (latestTag) {
		String base = latestTag.startsWith('v') ? latestTag.substring(1) : latestTag
		return base + "-SNAPSHOT"
	}
	return "0.0.0-SNAPSHOT"
}

static String execAndRead(String cmd) {
	try {
		def p = cmd.execute()
		p.waitFor()
		return p.exitValue() == 0 ? p.text.trim() : null
	} catch (Exception ignored) {
		return null
	}
}
